From 9b134cbab72a61b9303fcfd3cf73d812e7b98c6b Mon Sep 17 00:00:00 2001
From: Osmond Chen <osmond.chen@mic.com.tw>
Date: Tue, 15 Feb 2022 13:25:58 +0800
Subject: [PATCH] Modify file path and max size of console log

---
 log-handler.c | 19 +++++++++++++++----
 1 file changed, 15 insertions(+), 4 deletions(-)

diff --git a/log-handler.c b/log-handler.c
index 6368ad7..2b05076 100755
--- a/log-handler.c
+++ b/log-handler.c
@@ -40,7 +40,7 @@ struct log_handler {
 };
 
 
-static const char *default_filename = LOCALSTATEDIR "/log/obmc-console.log";
+static const char *default_filename = "/var/lib/obmc-console/obmc-console.log";
 static const size_t default_logsize = 4 * 1024;
 
 static struct log_handler *to_log_handler(struct handler *handler)
@@ -134,6 +134,7 @@ static int log_init(struct handler *handler, struct console *console,
 	const char *filename, *logsize_str;
 	size_t logsize = default_logsize;
 	int rc;
+	char md_cmd[128], *folderPath = "/var/lib/obmc-console";
 
 	lh->console = console;
 	lh->pagesize = 4096;
@@ -151,18 +152,28 @@ static int log_init(struct handler *handler, struct console *console,
 	filename = config_get_value(config, "logfile");
 	if (!filename)
 		filename = default_filename;
-
+	
+	// Create directory of log file. 
+	if (0 != access(folderPath, 0))
+	{
+		snprintf(md_cmd, sizeof(md_cmd), "mkdir %s",folderPath);
+		int systemRet = system(md_cmd);
+		if (systemRet != 0)
+		{
+			warn("Can't create directory %s", folderPath);
+		}
+	}
 	lh->fd = open(filename, O_RDWR | O_CREAT, 0644);
 	if (lh->fd < 0) {
 		warn("Can't open log buffer file %s", filename);
 		return -1;
 	}
-	rc = ftruncate(lh->fd, 0);
+	/*rc = ftruncate(lh->fd, 0);
 	if (rc) {
 		warn("Can't truncate file %s", filename);
 		close(lh->fd);
 		return -1;
-	}
+	}*/
 
 	lh->rbc = console_ringbuffer_consumer_register(console,
 			log_ringbuffer_poll, lh);
-- 
2.7.4

