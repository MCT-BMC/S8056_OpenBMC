From 5fe4aec0f6c99dacfcee70e84bbb5a39741e8dec Mon Sep 17 00:00:00 2001
From: "Cheng.Yenmin" <Yenminc@hyvedesignsolutions.com>
Date: Mon, 3 Jan 2022 13:34:51 +0800
Subject: [PATCH] [u-boot-aspeed-sdk] Add function to read mac from eeprom and
 set to eth1.(kernel:eth0)

Signed-off-by: Cheng.Yenmin <Yenminc@hyvedesignsolutions.com>
---
 net/eth-uclass.c | 31 +++++++++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/net/eth-uclass.c b/net/eth-uclass.c
index a7f8792710..dbf6b8a024 100644
--- a/net/eth-uclass.c
+++ b/net/eth-uclass.c
@@ -12,6 +12,13 @@
 #include <dm/device-internal.h>
 #include <dm/uclass-internal.h>
 #include "eth_internal.h"
+#include <command.h>
+#include <i2c.h>
+
+#define CONFIG_SYS_EEPROM_BUS_NUM 1
+#define CONFIG_SYS_I2C_EEPROM_ADDR 0x50
+#define CONFIG_SYS_I2C_EEPROM_ADDR_LEN 2
+#define CONFIG_SYS_I2C_MAC_OFFSET 0x40
 
 DECLARE_GLOBAL_DATA_PTR;
 
@@ -460,12 +467,36 @@ static int eth_pre_unbind(struct udevice *dev)
 	return 0;
 }
 
+int read_mac_from_eeprom(void)
+{
+        int ret;
+        unsigned int bus;
+        u_int8_t mac[6];
+        bus = i2c_get_bus_num();
+        i2c_set_bus_num(CONFIG_SYS_EEPROM_BUS_NUM);
+
+        i2c_read(CONFIG_SYS_I2C_EEPROM_ADDR,
+			CONFIG_SYS_I2C_MAC_OFFSET,
+			CONFIG_SYS_I2C_EEPROM_ADDR_LEN,
+			mac,
+			6);
+
+        i2c_set_bus_num(bus);
+
+        eth_env_set_enetaddr_by_index("eth",0,mac); //set eth0 mac address
+
+        return 0;
+}
+
 static int eth_post_probe(struct udevice *dev)
 {
 	struct eth_device_priv *priv = dev->uclass_priv;
 	struct eth_pdata *pdata = dev->platdata;
 	unsigned char env_enetaddr[ARP_HLEN];
 
+	//Read MAC from EEPROM
+	read_mac_from_eeprom();
+
 #if defined(CONFIG_NEEDS_MANUAL_RELOC)
 	struct eth_ops *ops = eth_get_ops(dev);
 	static int reloc_done;
-- 
2.17.1

