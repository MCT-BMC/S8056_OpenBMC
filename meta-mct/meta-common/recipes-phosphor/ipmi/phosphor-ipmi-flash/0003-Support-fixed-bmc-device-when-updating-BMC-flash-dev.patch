From 1f56507acf46b0f5ace4901ff61ebf03e8ff8d0b Mon Sep 17 00:00:00 2001
From: John Chung <john.chung@mic.com.tw>
Date: Tue, 27 Dec 2022 13:19:55 +0800
Subject: [PATCH] Support fixed bmc device when updating BMC flash device

---
 bmc/firmware-handler/firmware_handler.cpp | 20 +++++++++++++++++++-
 1 file changed, 19 insertions(+), 1 deletion(-)

diff --git a/bmc/firmware-handler/firmware_handler.cpp b/bmc/firmware-handler/firmware_handler.cpp
index 0c2f2a3..bfd3315 100755
--- a/bmc/firmware-handler/firmware_handler.cpp
+++ b/bmc/firmware-handler/firmware_handler.cpp
@@ -286,7 +286,7 @@ bool FirmwareBlobHandler::stat(uint16_t session, blobs::BlobMeta* meta)
  * blob_id when it is already open will fail.
  */
 bool FirmwareBlobHandler::open(uint16_t session, uint16_t flags,
-                               const std::string& path)
+                               const std::string& inputPath)
 {
     /* Is there an open session already? We only allow one at a time.
      *
@@ -304,6 +304,24 @@ bool FirmwareBlobHandler::open(uint16_t session, uint16_t flags,
         return false;
     }
 
+    std::string path = inputPath;
+
+    static const std::string bootSourceFilePath = "/run/boot-source";
+    uint8_t bootSource = 0;
+    std::ifstream ifs(bootSourceFilePath);
+    std::string line;
+    getline(ifs, line);
+    bootSource = std::stoi(line);
+
+    if (path == "/flash/backup" && bootSource == 1)
+    {
+        path = "/flash/image";
+    }
+    else if (path == "/flash/image" && bootSource == 1)
+    {
+        path = "/flash/backup";
+    }
+
     /* The active blobs are only meant to indicate status that something has
      * opened the image file or the hash file.
      */
-- 
2.25.1

