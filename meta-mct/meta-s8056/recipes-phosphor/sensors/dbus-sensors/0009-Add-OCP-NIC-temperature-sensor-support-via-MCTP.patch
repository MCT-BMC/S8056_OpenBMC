From 9b13bce73414f19fb90ef4f24a34d7e61d353360 Mon Sep 17 00:00:00 2001
From: Osmond Chen <osmond.chen@mic.com.tw>
Date: Thu, 24 Mar 2022 10:04:35 +0800
Subject: [PATCH] Add OCP NIC temperature sensor support via MCTP

---
 meson.build               |  2 ++
 meson_options.txt         |  1 +
 service_files/meson.build |  1 +
 src/meson.build           | 20 ++++++++++++++++++++
 4 files changed, 24 insertions(+)

diff --git a/meson.build b/meson.build
index fbf2462..c8d9a31 100755
--- a/meson.build
+++ b/meson.build
@@ -35,6 +35,8 @@ gpiodcxx = dependency(
     default_options: ['bindings=cxx'],
 )
 
+obmci2c = meson.get_compiler('cpp').find_library('obmci2c')
+
 # i2c-tools doesn't ship a pkg-config file for libi2c
 i2c = meson.get_compiler('cpp').find_library('i2c')
 
diff --git a/meson_options.txt b/meson_options.txt
index dd8f832..a7d627a 100755
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -14,6 +14,7 @@ option('event', type: 'feature', value: 'enabled', description: 'Enable Event-on
 option('mos-temp', type: 'feature', value: 'enabled', description: 'Enable MOS temperature sensor.',)
 option('fan-presence', type: 'feature', value: 'enabled', description: 'Enable FAN presence sensor.',)
 option('dimm-temp', type: 'feature', value: 'enabled', description: 'Enable DIMM temperature sensor.',)
+option('nic', type: 'feature', value: 'enabled', description: 'Enable NIC over MCTP sensor.',)
 option('tests', type: 'feature', value: 'enabled', description: 'Build tests.',)
 option('validate-unsecure-feature', type : 'feature', value : 'disabled', description : 'Enables unsecure features required by validation. Note: mustbe turned off for production images.',)
 option('insecure-sensor-override', type : 'feature', value : 'disabled', description : 'Enables Sensor override feature without any check.',)
diff --git a/service_files/meson.build b/service_files/meson.build
index 9d94f0c..3927b49 100755
--- a/service_files/meson.build
+++ b/service_files/meson.build
@@ -14,6 +14,7 @@ unit_files = [
     ['mos-temp', 'xyz.openbmc_project.mostempsensor.service'],
     ['fan-presence', 'xyz.openbmc_project.fanpresencesensor.service'],
     ['dimm-temp', 'xyz.openbmc_project.dimmtempsensor.service'],
+    ['nic', 'xyz.openbmc_project.nicsensor.service'],
 ]
 
 foreach tuple : unit_files
diff --git a/src/meson.build b/src/meson.build
index 1eb6b9b..7ea6c01 100755
--- a/src/meson.build
+++ b/src/meson.build
@@ -265,3 +265,23 @@ if get_option('dimm-temp').enabled()
         ],
     )
 endif
+
+if get_option('nic').enabled()
+    executable(
+        'nicsensor',
+        'NICSensor.cpp',
+        'NICSensorMain.cpp',
+        dependencies: [
+            i2c,
+            obmci2c,
+            sdbusplus,
+        ],
+        implicit_include_directories: false,
+        include_directories: '../include',
+        install: true,
+        link_with: [
+            thresholds_a,
+            utils_a,
+        ],
+    )
+endif
-- 
2.7.4

